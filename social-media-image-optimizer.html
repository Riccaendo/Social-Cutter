<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Social Media Image Optimizer</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚úÇÔ∏è</text></svg>" type="image/svg+xml">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
  <style>
    :root {
      --primary: #4a6cff;
      --secondary: #212225;
      --dark: #bdbdbd;
      --light: #393939;
      --gray: #3f4147;
      --success: #4CAF50;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: var(--secondary);
      color: var(--dark);
      min-height: 100vh;
      padding: 20px;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    h1 {
      font-size: 2.2rem;
      margin-bottom: 10px;
      color: var(--primary);
    }
    
    .subtitle {
      font-size: 1.1rem;
      color: #ffffff;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .upload-container {
      background-color: var(--light);
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      text-align: center;
    }
    
    .upload-area {
      border: 2px dashed var(--gray);
      border-radius: 8px;
      padding: 40px 20px;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 20px;
    }
    
    .upload-area:hover {
      border-color: var(--primary);
      background-color: rgba(74, 108, 255, 0.05);
    }
    
    .upload-icon {
      font-size: 48px;
      color: var(--primary);
      margin-bottom: 15px;
    }
    
    .file-input {
      display: none;
    }
    
    .btn {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 12px 20px;
      margin: 10px 0;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-block;
      font-weight: 500;
    }
    
    .btn:hover {
      background-color: #3a5cdf;
      transform: translateY(-2px);
    }
    
    .btn:disabled {
      background-color: #a0a0a0;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background-color: var(--gray);
      color: var(--dark);
    }
    
    .btn-secondary:hover {
      background-color: #d0d4e0;
    }
    
    .btn-red {
      background-color: #e74c3c;
      color: white;
      margin: 20px 0;
    }

    .btn-red:hover {
      background-color: #c0392b;
    }
    
    .formats-container {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
    }
    
    .format-option {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .editor-container {
      display: none;
      background-color: var(--light);
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    
    .img-container {
      max-width: 100%;
      height: 500px;
      margin: 0 auto 20px;
    }
    
    img {
      max-width: 100%;
      display: block;
    }
    
    .social-platforms {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
    }
    
    .platform-btn {
      background-color: #a0a0a0;
      border: 1px solid var(--gray);
      border-radius: 6px;
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .platform-btn.active {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .platform-btn:hover:not(.active) {
      background-color: var(--gray);
    }
    
    .previews-container {
      display: none;
      background-color: var(--light);
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .preview-item {
      background-color: var(--secondary);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .preview-image {
      width: 100%;
      height: 180px;
      object-fit: contain;
      background-color: #181818;
      padding: 10px;
    }
    
    .preview-info {
      padding: 15px;
    }
    
    .preview-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .preview-size {
      font-size: 13px;
      color: #666;
      margin-bottom: 15px;
    }
    
    .controls {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 20px;
    }
    
    .success-message {
      display: none;
      background-color: var(--success);
      color: white;
      padding: 15px;
      border-radius: 6px;
      margin-top: 20px;
      text-align: center;
    }
    
    .title-button {
      cursor: pointer;
      display: inline-block;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .title-button:hover {
      transform: scale(1.03);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .title-button:active {
      transform: scale(0.98);
    }
    
    .title-button::after {
      content: '';
      position: absolute;
      width: 0;
      height: 2px;
      bottom: -4px;
      left: 0;
      background-color: var(--primary);
      transition: width 0.3s ease;
    }
    
    .title-button:hover::after {
      width: 100%;
    }

    .platform-separator {
      width: 100%;
      margin: 20px 0;
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .platform-separator-line {
      flex-grow: 1;
      height: 1px;
      background-color: var(--gray);
    }

    .platform-separator-text {
      font-weight: 600;
      color: var(--primary);
      font-size: 18px;
      padding: 0 10px;
    }

    .filename-editor {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
      background-color: var(--secondary);
      padding: 12px;
      border-radius: 8px;
    }

    .filename-editor label {
      font-weight: 500;
      white-space: nowrap;
    }

    .filename-editor input {
      flex-grow: 1;
      background-color: var(--light);
      border: 1px solid var(--gray);
      border-radius: 6px;
      padding: 8px 12px;
      color: var(--dark);
      font-size: 14px;
    }

    .filename-editor input:focus {
      border-color: var(--primary);
      outline: none;
    }

    .custom-dimensions {
      margin-top: 20px;
      padding: 15px;
      background-color: var(--secondary);
      border-radius: 8px;
      display: none;
    }

    .custom-dimensions-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .custom-dimensions h3 {
      margin: 0;
      font-size: 16px;
      color: var(--dark);
    }

    .custom-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }

    .custom-item {
      background-color: var(--light);
      border-radius: 6px;
      padding: 10px;
      position: relative;
    }

    .custom-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .custom-item-title {
      font-weight: 600;
      color: var(--dark);
    }

    .remove-custom-btn {
      background: none;
      border: none;
      color: #ff6b6b;
      cursor: pointer;
      font-size: 16px;
    }

    .custom-item-inputs {
      display: grid;
      grid-template-columns: 1fr 30px 1fr;
      gap: 10px;
      align-items: center;
    }

    .custom-input-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .custom-input-group label {
      font-size: 12px;
      color: var(--dark);
    }

    .custom-input-group input {
      background-color: var(--secondary);
      border: 1px solid var(--gray);
      border-radius: 4px;
      padding: 5px 8px;
      color: var(--dark);
      font-size: 14px;
    }

    .aspect-ratio-lock {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 5px;
      background-color: var(--secondary);
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid var(--gray);
      margin-top: 26px;
      height: 30px;
      width: 30px;
      transition: all 0.2s;
      color: var(--dark);
    }

    .aspect-ratio-lock.locked {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .add-custom-container {
      display: flex;
      justify-content: center;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      .preview-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
      
      .controls {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }

    .button-container {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .button-container .btn {
      flex: 1;
    }

    .crop-editor-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }

    .crop-editor-wrapper {
      width: 100%;
      max-width: 1000px;
      background-color: white;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .crop-editor-header {
      padding: 15px 20px;
      background-color: var(--primary);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .crop-image-container {
      padding: 20px;
      height: 500px;
      background-color: #181818;
    }

    .crop-editor-footer {
      padding: 20px;
      border-top: 1px solid var(--gray);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      background-color: #212225;
    }
  </style>
</head>
<body>
  <header>
    <h1 id="titleButton" class="title-button">Cutter Immagini social Media</h1>
    <p class="subtitle">Carica, ottimizza e scarica le tue immagini per tutti i social network in pochi clic</p>
  </header>
  
  <div class="container">
    <!-- Upload Section -->
    <div class="upload-container">
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìÅ</div>
        <h2>Carica un'immagine</h2>
        <p>Trascina qui il tuo file o clicca per selezionarlo</p>
        <p>JPG, PNG o WEBP</p>
      </div>
      <input type="file" id="fileInput" class="file-input" accept="image/jpeg,image/png,image/webp">
    </div>
    
    <!-- Editor Section -->
    <div class="editor-container" id="editorContainer">
      <h2>Modifica l'immagine</h2>
      <p>Seleziona i social per cui vuoi ottimizzare l'immagine</p>
      
      <div class="social-platforms">
        <button class="platform-btn active" data-platform="facebook">Facebook</button>
        <button class="platform-btn active" data-platform="instagram">Instagram</button>
        <button class="platform-btn active" data-platform="twitter">Twitter</button>
        <button class="platform-btn active" data-platform="linkedin">LinkedIn</button>
        <button class="platform-btn active" data-platform="pinterest">Pinterest</button>
        <button class="platform-btn active" data-platform="youtube">YouTube</button>
        <button class="platform-btn active" data-platform="tiktok">TikTok</button>
        <button class="platform-btn active" data-platform="artstation">ArtStation</button>
        <button class="platform-btn active" data-platform="cara">Cara</button>
      </div>
      
      <button class="btn btn-red" id="customToggle" style="margin-top: 15px;">
        + Aggiungi dimensioni personalizzate
      </button>
      
      <div class="custom-dimensions" id="customDimensions">
        <div class="custom-dimensions-title">
          <h3>Dimensioni personalizzate</h3>
        </div>
        
        <div class="custom-items" id="customItems">
          <!-- Gli elementi personalizzati verranno aggiunti qui -->
        </div>
        
        <div class="add-custom-container">
          <button class="btn btn-secondary" id="addCustomBtn">Aggiungi formato</button>
        </div>
      </div>
      
      <div class="img-container">
        <img id="previewImage" src="">
      </div>
      
      <div class="controls">
        <button class="btn btn-secondary" id="resetBtn">Ricomincia</button>
        <button class="btn" id="generateBtn">Genera immagini</button>
      </div>
    </div>
    
    <!-- Previews Section -->
    <div class="previews-container" id="previewsContainer">
      <h2>Anteprima delle immagini ottimizzate</h2>
      <p>Ecco le tue immagini pronte per i social media</p>
      
      <div class="filename-editor">
        <label for="fileNameInput">Nome file:</label>
        <input type="text" id="fileNameInput" placeholder="Inserisci il nome del file">
      </div>
      
      <div class="formats-container" style="margin-top: 15px; background-color: var(--secondary); padding: 12px; border-radius: 8px; text-align: center;">
        <label style="margin-right: 15px; font-weight: 500;">Formato:</label>
        <div class="format-option">
          <input type="radio" id="formatJpg" name="format" value="jpg" checked>
          <label for="formatJpg">JPG</label>
        </div>
        <div class="format-option">
          <input type="radio" id="formatPng" name="format" value="png">
          <label for="formatPng">PNG</label>
        </div>
        <div class="format-option">
          <input type="radio" id="formatWebp" name="format" value="webp">
          <label for="formatWebp">WEBP</label>
        </div>
      </div>

      
      
      <div class="preview-grid" id="previewGrid">
        <!-- Previews will be added here dynamically -->
      </div>
      
      <div class="controls">
        <button class="btn btn-secondary" id="backBtn">Indietro</button>
        <div style="display: flex; gap: 10px; margin-left: auto;">
          <button class="btn" style="background-color: var(--success);" id="newUploadBtn">Carica nuovo</button>
          <button class="btn" id="downloadAllBtn">Scarica tutte</button>
        </div>
      </div>
      
      <div class="success-message" id="successMessage">
        Immagini scaricate con successo!
      </div>
    </div>
  </div>
  
  <script>
    // Sostituisci l'oggetto platformDimensions esistente con questa versione estesa
    const platformDimensions = {
      facebook: {
        post: { width: 1200, height: 630, name: 'Facebook Post' },
        profile: { width: 170, height: 170, name: 'Facebook Profile' },
        cover: { width: 820, height: 312, name: 'Facebook Cover' },
        story: { width: 1080, height: 1920, name: 'Facebook Story' },
        event: { width: 1920, height: 1080, name: 'Facebook Event' },
        group: { width: 1640, height: 856, name: 'Facebook Group Cover' },
        ad: { width: 1200, height: 628, name: 'Facebook Ad' }
      },
      instagram: {
        post: { width: 1080, height: 1080, name: 'Instagram Post Quadrato' },
        portrait: { width: 1080, height: 1350, name: 'Instagram Post Verticale' },
        landscape: { width: 1080, height: 566, name: 'Instagram Post Orizzontale' },
        story: { width: 1080, height: 1920, name: 'Instagram Story' },
        profile: { width: 320, height: 320, name: 'Instagram Profile' },
        reel: { width: 1080, height: 1920, name: 'Instagram Reel' }
      },
      twitter: {
        post: { width: 1200, height: 675, name: 'Twitter Post' },
        profile: { width: 400, height: 400, name: 'Twitter Profile' },
        header: { width: 1500, height: 500, name: 'Twitter Header' },
        card: { width: 800, height: 418, name: 'Twitter Card' }
      },
      linkedin: {
        post: { width: 1200, height: 627, name: 'LinkedIn Post' },
        profile: { width: 400, height: 400, name: 'LinkedIn Profile' },
        cover: { width: 1584, height: 396, name: 'LinkedIn Cover' },
        banner: { width: 1128, height: 376, name: 'LinkedIn Company Banner' },
        blog: { width: 1200, height: 644, name: 'LinkedIn Article' }
      },
      pinterest: {
        standard: { width: 1000, height: 1500, name: 'Pinterest Standard' },
        square: { width: 1000, height: 1000, name: 'Pinterest Square' },
        profile: { width: 165, height: 165, name: 'Pinterest Profile' },
        board: { width: 800, height: 800, name: 'Pinterest Board Cover' }
      },
      youtube: {
        thumbnail: { width: 1280, height: 720, name: 'YouTube Thumbnail' },
        channel: { width: 2560, height: 1440, name: 'YouTube Channel Cover' },
        profile: { width: 800, height: 800, name: 'YouTube Profile' }
      },
      tiktok: {
        video: { width: 1080, height: 1920, name: 'TikTok Video' },
        profile: { width: 200, height: 200, name: 'TikTok Profile' }
      },
      artstation: {
        cover: { width: 1920, height: 1080, name: 'ArtStation Cover' },
        thumbnail: { width: 1200, height: 900, name: 'ArtStation Thumbnail' },
        profile: { width: 256, height: 256, name: 'ArtStation Profile' },
        custom: { width: 4000, height: 0, name: 'ArtStation Custom 4000px', autoHeight: true }
      },
      cara: {
        standard: { width: 800, height: 600, name: 'Cara Standard' },
        square: { width: 600, height: 600, name: 'Cara Square' },
        banner: { width: 1200, height: 300, name: 'Cara Banner' }
      }
    };
    
    // DOM Elements
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const editorContainer = document.getElementById('editorContainer');
    const previewsContainer = document.getElementById('previewsContainer');
    const previewImage = document.getElementById('previewImage');
    const previewGrid = document.getElementById('previewGrid');
    const resetBtn = document.getElementById('resetBtn');
    const generateBtn = document.getElementById('generateBtn');
    const backBtn = document.getElementById('backBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const successMessage = document.getElementById('successMessage');
    const platformButtons = document.querySelectorAll('.platform-btn');
    const fileNameInput = document.getElementById('fileNameInput');
    const customToggle = document.getElementById('customToggle');
    const customDimensions = document.getElementById('customDimensions');
    const customItems = document.getElementById('customItems');
    const addCustomBtn = document.getElementById('addCustomBtn');
    
    // Variables
    let cropper;
    let originalImage;
    let fileName = '';
    let fileType = '';
    let generatedImages = {};
    let customCounter = 1;
    
    // Event Listeners
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'var(--primary)';
      uploadArea.style.backgroundColor = 'rgba(74, 108, 255, 0.05)';
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.style.borderColor = 'var(--gray)';
      uploadArea.style.backgroundColor = '';
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'var(--gray)';
      uploadArea.style.backgroundColor = '';
      
      if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        handleFileUpload();
      }
    });
    
    fileInput.addEventListener('change', handleFileUpload);
    resetBtn.addEventListener('click', resetApp);
    generateBtn.addEventListener('click', generateImages);
    backBtn.addEventListener('click', goBackToEditor);
    downloadAllBtn.addEventListener('click', downloadAllImages);
    
    platformButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        btn.classList.toggle('active');
      });
    });
    
    customToggle.addEventListener('click', () => {
      customDimensions.style.display = customDimensions.style.display === 'none' || customDimensions.style.display === '' ? 'block' : 'none';
    });
    
    addCustomBtn.addEventListener('click', addCustomDimension);
    
    // Functions
    function handleFileUpload() {
      const file = fileInput.files[0];
      
      if (!file) return;
      
      // Check if file is an image
      if (!file.type.match('image.*')) {
        alert('Per favore carica un file immagine valido (JPG, PNG, WEBP)');
        return;
      }
      
      // Estrai il nome del file senza estensione
      fileName = file.name.split('.')[0];
      fileType = file.type;
      
      // Imposta il valore iniziale nel campo di input
      fileNameInput.value = fileName;
      
      const reader = new FileReader();
      
      reader.onload = (e) => {
        // Create an image element to get dimensions
        originalImage = new Image();
        originalImage.src = e.target.result;
        
        originalImage.onload = () => {
          // Display the editor
          previewImage.src = e.target.result;
          editorContainer.style.display = 'block';
          document.querySelector('.upload-container').style.display = 'none';
          
          // Initialize cropper
          if (cropper) {
            cropper.destroy();
          }
          
          cropper = new Cropper(previewImage, {
            viewMode: 1,
            dragMode: 'move',
            aspectRatio: NaN,
            autoCropArea: 1,
            restore: false,
            guides: true,
            center: true,
            highlight: false,
            cropBoxMovable: true,
            cropBoxResizable: true,
            toggleDragModeOnDblclick: false,
          });
        };
      };
      
      reader.readAsDataURL(file);
    }
    
    function resetApp() {
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      
      fileInput.value = '';
      editorContainer.style.display = 'none';
      previewsContainer.style.display = 'none';
      document.querySelector('.upload-container').style.display = 'block';
      generatedImages = {};
      successMessage.style.display = 'none';
      
      // Reset platform selections
      platformButtons.forEach(btn => {
        btn.classList.add('active');
      });
      
      // Reset custom dimensions
      customItems.innerHTML = '';
      customCounter = 1;
      customDimensions.style.display = 'none';
    }
    
    function addCustomDimension() {
      const customItem = document.createElement('div');
      customItem.className = 'custom-item';
      customItem.dataset.id = `custom-${customCounter}`;
      
      const customItemHeader = document.createElement('div');
      customItemHeader.className = 'custom-item-header';
      
      const customItemTitle = document.createElement('div');
      customItemTitle.className = 'custom-item-title';
      customItemTitle.textContent = `Formato personalizzato ${customCounter}`;
      
      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-custom-btn';
      removeBtn.innerHTML = '&times;';
      removeBtn.addEventListener('click', () => {
        customItems.removeChild(customItem);
      });
      
      const customItemInputs = document.createElement('div');
      customItemInputs.className = 'custom-item-inputs';
      
      // Input larghezza
      const widthGroup = document.createElement('div');
      widthGroup.className = 'custom-input-group';
      
      const widthLabel = document.createElement('label');
      widthLabel.textContent = 'Larghezza (px)';
      
      const widthInput = document.createElement('input');
      widthInput.type = 'number';
      widthInput.min = '10';
      widthInput.max = '4000';
      widthInput.value = '1200';
      widthInput.className = 'width-input';
      
      widthGroup.appendChild(widthLabel);
      widthGroup.appendChild(widthInput);
      
      const lockButton = document.createElement('div');
      lockButton.className = 'aspect-ratio-lock';
      lockButton.innerHTML = 'üîì';
      lockButton.title = 'Blocca proporzioni';
      
      let locked = false;
      let aspectRatio = 1200 / 630; // Rapporto iniziale basato sui valori predefiniti
      
      lockButton.addEventListener('click', () => {
        locked = !locked;
        if (locked) {
          lockButton.innerHTML = 'üîí';
          lockButton.classList.add('locked');
          aspectRatio = parseInt(widthInput.value) / parseInt(heightInput.value);
        } else {
          lockButton.innerHTML = 'üîì';
          lockButton.classList.remove('locked');
        }
      });
      
      // Input altezza
      const heightGroup = document.createElement('div');
      heightGroup.className = 'custom-input-group';
      
      const heightLabel = document.createElement('label');
      heightLabel.textContent = 'Altezza (px)';
      
      const heightInput = document.createElement('input');
      heightInput.type = 'number';
      heightInput.min = '10';
      heightInput.max = '4000';
      heightInput.value = '630';
      heightInput.className = 'height-input';
      
      heightGroup.appendChild(heightLabel);
      heightGroup.appendChild(heightInput);
      
      // Eventi per mantenere le proporzioni
      widthInput.addEventListener('input', () => {
        if (locked && widthInput.value) {
          const newWidth = parseInt(widthInput.value);
          if (!isNaN(newWidth) && newWidth > 0) {
            const newHeight = Math.round(newWidth / aspectRatio);
            heightInput.value = newHeight;
          }
        }
      });
      
      heightInput.addEventListener('input', () => {
        if (locked && heightInput.value) {
          const newHeight = parseInt(heightInput.value);
          if (!isNaN(newHeight) && newHeight > 0) {
            const newWidth = Math.round(newHeight * aspectRatio);
            widthInput.value = newWidth;
          }
        }
      });
      
      customItemInputs.appendChild(widthGroup);
      customItemInputs.appendChild(lockButton);
      customItemInputs.appendChild(heightGroup);
      
      customItemHeader.appendChild(customItemTitle);
      customItemHeader.appendChild(removeBtn);
      
      customItem.appendChild(customItemHeader);
      customItem.appendChild(customItemInputs);
      
      customItems.appendChild(customItem);
      
      customCounter++;
    }
    
    function generateImages() {
      // Clear previous previews
      previewGrid.innerHTML = '';
      generatedImages = {};
      
      // Get selected platforms
      const selectedPlatforms = [];
      platformButtons.forEach(btn => {
        if (btn.classList.contains('active')) {
          selectedPlatforms.push(btn.dataset.platform);
        }
      });
      
      // Aggiungi il controllo per i formati personalizzati
      const customFormats = [];
      const customItems = document.querySelectorAll('.custom-item');
      customItems.forEach((item, index) => {
        const widthInput = item.querySelector('.width-input');
        const heightInput = item.querySelector('.height-input');
        
        if (widthInput && heightInput) {
          const width = parseInt(widthInput.value);
          const height = parseInt(heightInput.value);
          
          if (!isNaN(width) && !isNaN(height) && width > 0 && height > 0) {
            customFormats.push({
              id: item.dataset.id,
              width,
              height,
              name: `Formato personalizzato ${index + 1} (${width}√ó${height})`
            });
          }
        }
      });
      
      if (selectedPlatforms.length === 0 && customFormats.length === 0) {
        alert('Seleziona almeno una piattaforma o aggiungi un formato personalizzato');
        return;
      }
      
      // Get selected format
      const format = document.querySelector('input[name="format"]:checked').value;
      const mimeType = format === 'jpg' ? 'image/jpeg' : 
                      format === 'png' ? 'image/png' : 'image/webp';
      
      // Get cropped image
      const croppedCanvas = cropper.getCroppedCanvas();
      
      // Store the original cropped canvas data to use it for custom crops
      const originalCroppedDataUrl = croppedCanvas.toDataURL(mimeType, format === 'jpg' ? 0.9 : 1);
      
      // Generate images for each platform and subtype
      selectedPlatforms.forEach((platform, platformIndex) => {
        // Add a separator for each platform with platform name
        const separator = document.createElement('div');
        separator.className = 'platform-separator';
        
        const line1 = document.createElement('div');
        line1.className = 'platform-separator-line';
        
        const text = document.createElement('div');
        text.className = 'platform-separator-text';
        
        // Get readable platform name
        const platformName = platform.charAt(0).toUpperCase() + platform.slice(1);
        text.textContent = platformName;
        
        const line2 = document.createElement('div');
        line2.className = 'platform-separator-line';
        
        separator.appendChild(line1);
        separator.appendChild(text);
        separator.appendChild(line2);
        
        previewGrid.appendChild(separator);
        
        const platformTypes = platformDimensions[platform];
        
        // Loop through all subtypes of this platform
        Object.keys(platformTypes).forEach(subtype => {
          const { width, height, name, autoHeight } = platformTypes[subtype];
          
          // Handle autoHeight option for ArtStation Custom
          let targetWidth = width;
          let targetHeight = height;
          
          if (autoHeight === true) {
            // Calculate height proportionally based on the width
            const aspectRatio = croppedCanvas.height / croppedCanvas.width;
            targetHeight = Math.round(targetWidth * aspectRatio);
          }
          
          // Create a new canvas with the target dimensions
          const canvas = document.createElement('canvas');
          canvas.width = targetWidth;
          canvas.height = targetHeight;
          const ctx = canvas.getContext('2d');
          
          // Fill with white background (for transparent PNGs)
          if (format !== 'png') {
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, targetWidth, targetHeight);
          }
          
          // For autoHeight option, we maintain the exact aspect ratio of the cropped image
          if (autoHeight === true) {
            ctx.drawImage(croppedCanvas, 0, 0, targetWidth, targetHeight);
          } else {
            // For standard options, we handle different aspect ratios
            // Calculate scaling and positioning
            const croppedAspect = croppedCanvas.width / croppedCanvas.height;
            const targetAspect = targetWidth / targetHeight;
            
            let drawWidth, drawHeight, x, y;
            
            if (croppedAspect > targetAspect) {
              drawHeight = targetHeight;
              drawWidth = targetHeight * croppedAspect;
              x = (targetWidth - drawWidth) / 2;
              y = 0;
            } else {
              drawWidth = targetWidth;
              drawHeight = targetWidth / croppedAspect;
              x = 0;
              y = (targetHeight - drawHeight) / 2;
            }
            
            ctx.drawImage(croppedCanvas, x, y, drawWidth, drawHeight);
          }
          
          const dataUrl = canvas.toDataURL(mimeType, format === 'jpg' ? 0.9 : 1);
          
          // Store using a combined key
          const key = `${platform}_${subtype}`;
          generatedImages[key] = {
            dataUrl,
            width: targetWidth,
            height: targetHeight,
            platform,
            subtype,
            name,
            format,
            // Store cropping parameters for later editing
            cropParams: {
              x: 0, 
              y: 0, 
              drawWidth: targetWidth, 
              drawHeight: targetHeight,
              originalDataUrl: originalCroppedDataUrl,
              autoHeight: autoHeight === true
            }
          };
          
          // Crea l'elemento di anteprima
          createPreviewItem(key, dataUrl, name, targetWidth, targetHeight);
        });
      });
      
      // Elabora i formati personalizzati se presenti
      if (customFormats.length > 0) {
        // Aggiungi un separatore per i formati personalizzati
        const separator = document.createElement('div');
        separator.className = 'platform-separator';
        
        const line1 = document.createElement('div');
        line1.className = 'platform-separator-line';
        
        const text = document.createElement('div');
        text.className = 'platform-separator-text';
        text.textContent = 'Formati personalizzati';
        
        const line2 = document.createElement('div');
        line2.className = 'platform-separator-line';
        
        separator.appendChild(line1);
        separator.appendChild(text);
        separator.appendChild(line2);
        
        previewGrid.appendChild(separator);
        
        // Elabora ogni formato personalizzato
        customFormats.forEach(customFormat => {
          const { id, width, height, name } = customFormat;
          
          // Crea una nuova canvas con le dimensioni target
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          
          // Riempi con sfondo bianco (per PNG trasparenti)
          if (format !== 'png') {
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, width, height);
          }
          
          // Gestisci le diverse proporzioni
          const croppedAspect = croppedCanvas.width / croppedCanvas.height;
          const targetAspect = width / height;
          
          let drawWidth, drawHeight, x, y;
          
          if (croppedAspect > targetAspect) {
            drawHeight = height;
            drawWidth = height * croppedAspect;
            x = (width - drawWidth) / 2;
            y = 0;
          } else {
            drawWidth = width;
            drawHeight = width / croppedAspect;
            x = 0;
            y = (height - drawHeight) / 2;
          }
          
          ctx.drawImage(croppedCanvas, x, y, drawWidth, drawHeight);
          
          const dataUrl = canvas.toDataURL(mimeType, format === 'jpg' ? 0.9 : 1);
          
          // Memorizza usando una chiave combinata
          const key = `custom_${id}`;
          generatedImages[key] = {
            dataUrl,
            width,
            height,
            platform: 'custom',
            subtype: id,
            name,
            format,
            // Memorizza i parametri di ritaglio per la modifica successiva
            cropParams: {
              x: 0, 
              y: 0, 
              drawWidth: width, 
              drawHeight: height,
              originalDataUrl: originalCroppedDataUrl,
              autoHeight: false
            }
          };
          
          // Crea l'elemento di anteprima
          createPreviewItem(key, dataUrl, name, width, height);
        });
      }
      
      // Mostra le anteprime
      editorContainer.style.display = 'none';
      previewsContainer.style.display = 'block';
    }
    
    // Funzione helper per creare elementi di anteprima
    function createPreviewItem(key, dataUrl, name, width, height) {
      const previewItem = document.createElement('div');
      previewItem.className = 'preview-item';
      
      const previewImage = document.createElement('img');
      previewImage.className = 'preview-image';
      previewImage.src = dataUrl;
      previewImage.alt = name;
      
      const previewInfo = document.createElement('div');
      previewInfo.className = 'preview-info';
      
      const previewTitle = document.createElement('div');
      previewTitle.className = 'preview-title';
      previewTitle.textContent = name;
      
      const previewSize = document.createElement('div');
      previewSize.className = 'preview-size';
      previewSize.textContent = `${width} √ó ${height} px`;
      
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'button-container';
      
      const downloadBtn = document.createElement('button');
      downloadBtn.className = 'btn';
      downloadBtn.textContent = 'Scarica';
      downloadBtn.addEventListener('click', () => {
        downloadImage(key);
      });
      
      const editBtn = document.createElement('button');
      editBtn.className = 'btn btn-secondary';
      editBtn.textContent = 'Ritaglia';
      editBtn.addEventListener('click', () => {
        openCustomCropEditor(key);
      });
      
      buttonContainer.appendChild(downloadBtn);
      buttonContainer.appendChild(editBtn);
      
      previewInfo.appendChild(previewTitle);
      previewInfo.appendChild(previewSize);
      previewInfo.appendChild(buttonContainer);
      
      previewItem.appendChild(previewImage);
      previewItem.appendChild(previewInfo);
      
      previewGrid.appendChild(previewItem);
    }
    
    function goBackToEditor() {
      previewsContainer.style.display = 'none';
      editorContainer.style.display = 'block';
      successMessage.style.display = 'none';
    }
    
    function downloadImage(key) {
      const image = generatedImages[key];
      if (!image) return;
      
      const { platform, subtype, format } = image;
      
      // Usa il valore dal campo input invece del fileName originale
      const customFileName = fileNameInput.value.trim() || fileName;
      
      const link = document.createElement('a');
      link.href = image.dataUrl;
      link.download = `${customFileName}_${platform}_${subtype}.${format}`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showSuccessMessage();
    }
    
    function downloadAllImages() {
      const keys = Object.keys(generatedImages);
      
      if (keys.length === 0) return;
      
      // Usa il valore dal campo input invece del fileName originale
      const customFileName = fileNameInput.value.trim() || fileName;
      
      // If only one image, download it directly
      if (keys.length === 1) {
        downloadImage(keys[0]);
        return;
      }
      
      // If multiple images, create a zip file
      const zip = new JSZip();
      const format = document.querySelector('input[name="format"]:checked').value;
      
      keys.forEach(key => {
        const image = generatedImages[key];
        const { platform, subtype } = image;
        
        // Convert data URL to blob
        const dataUrl = image.dataUrl;
        const binary = atob(dataUrl.split(',')[1]);
        const array = [];
        
        for (let i = 0; i < binary.length; i++) {
          array.push(binary.charCodeAt(i));
        }
        
        const blob = new Blob([new Uint8Array(array)], { 
          type: format === 'jpg' ? 'image/jpeg' : 
                format === 'png' ? 'image/png' : 'image/webp' 
        });
        
        zip.file(`${customFileName}_${platform}_${subtype}.${format}`, blob);
      });
      
      zip.generateAsync({ type: 'blob' }).then(content => {
        saveAs(content, `${customFileName}_social_images.zip`);
        showSuccessMessage();
      });
    }
    
    function showSuccessMessage() {
      successMessage.style.display = 'block';
      setTimeout(() => {
        successMessage.style.display = 'none';
      }, 3000);
    }

    function openCustomCropEditor(key) {
      const imageData = generatedImages[key];
      if (!imageData) return;
      
      // Crea un overlay per l'editor di ritaglio
      const overlay = document.createElement('div');
      overlay.className = 'crop-editor-overlay';
      
      // Contenitore dell'editor
      const editorWrapper = document.createElement('div');
      editorWrapper.className = 'crop-editor-wrapper';
      
      // Header dell'editor
      const editorHeader = document.createElement('div');
      editorHeader.className = 'crop-editor-header';
      
      const editorTitle = document.createElement('h3');
      editorTitle.textContent = `Modifica ritaglio - ${imageData.name} (${imageData.width} √ó ${imageData.height})`;
      editorTitle.style.margin = '0';
      
      const closeButton = document.createElement('button');
      closeButton.innerHTML = '&times;';
      closeButton.style.backgroundColor = 'transparent';
      closeButton.style.border = 'none';
      closeButton.style.color = 'white';
      closeButton.style.fontSize = '24px';
      closeButton.style.cursor = 'pointer';
      closeButton.addEventListener('click', () => {
        // Chiudi l'editor senza salvare
        document.body.removeChild(overlay);
      });
      
      editorHeader.appendChild(editorTitle);
      editorHeader.appendChild(closeButton);
      
      // Contenitore dell'immagine
      const imageContainer = document.createElement('div');
      imageContainer.className = 'crop-image-container';
      
      // Carica l'immagine originale per il ritaglio
      const cropperImage = document.createElement('img');
      cropperImage.src = imageData.cropParams.originalDataUrl;
      cropperImage.style.maxHeight = '100%';
      cropperImage.style.display = 'block';
      cropperImage.style.maxWidth = '100%';
      
      imageContainer.appendChild(cropperImage);
      
      // Footer con i pulsanti
      const editorFooter = document.createElement('div');
      editorFooter.className = 'crop-editor-footer';
      
      const cancelButton = document.createElement('button');
      cancelButton.className = 'btn btn-secondary';
      cancelButton.textContent = 'Annulla';
      cancelButton.addEventListener('click', () => {
        document.body.removeChild(overlay);
      });
      
      const saveButton = document.createElement('button');
      saveButton.className = 'btn';
      saveButton.textContent = 'Applica ritaglio';
      saveButton.addEventListener('click', () => {
        // Gestisci in modo diverso le opzioni con altezza automatica
        let canvas;
        
        if (imageData.cropParams.autoHeight) {
          // Per opzioni con altezza automatica, mantieni il rapporto d'aspetto del ritaglio
          const croppedCanvas = customCropper.getCroppedCanvas();
          const targetWidth = imageData.width;
          const aspectRatio = croppedCanvas.height / croppedCanvas.width;
          const targetHeight = Math.round(targetWidth * aspectRatio);
          
          // Crea una nuova canvas con le dimensioni corrette
          canvas = document.createElement('canvas');
          canvas.width = targetWidth;
          canvas.height = targetHeight;
          const ctx = canvas.getContext('2d');
          
          // Ridimensiona l'immagine ritagliata
          ctx.drawImage(croppedCanvas, 0, 0, targetWidth, targetHeight);
          
          // Aggiorna l'altezza nell'oggetto imageData
          imageData.height = targetHeight;
        } else {
          // Per opzioni standard, usa le dimensioni fisse
          canvas = customCropper.getCroppedCanvas({
            width: imageData.width,
            height: imageData.height
          });
        }
        
        const format = imageData.format;
        const mimeType = format === 'jpg' ? 'image/jpeg' : 
                        format === 'png' ? 'image/png' : 'image/webp';
                        
        const newDataUrl = canvas.toDataURL(mimeType, format === 'jpg' ? 0.9 : 1);
        
        // Aggiorna l'immagine generata
        generatedImages[key].dataUrl = newDataUrl;
        
        // Aggiorna l'anteprima nell'interfaccia
        const previewItems = document.querySelectorAll('.preview-item');
        for (const item of previewItems) {
          const previewTitle = item.querySelector('.preview-title');
          if (previewTitle.textContent === imageData.name) {
            const previewImage = item.querySelector('.preview-image');
            previewImage.src = newDataUrl;
            
            // Aggiorna anche le dimensioni visualizzate se √® un'opzione con altezza automatica
            if (imageData.cropParams.autoHeight) {
              const previewSize = item.querySelector('.preview-size');
              previewSize.textContent = `${imageData.width} √ó ${imageData.height} px`;
            }
            break;
          }
        }
        
        // Chiudi l'editor
        document.body.removeChild(overlay);
        
        // Mostra un messaggio di successo
        const successMsg = document.createElement('div');
        successMsg.textContent = 'Ritaglio applicato con successo!';
        successMsg.style.position = 'fixed';
        successMsg.style.bottom = '20px';
        successMsg.style.left = '50%';
        successMsg.style.transform = 'translateX(-50%)';
        successMsg.style.backgroundColor = 'var(--success)';
        successMsg.style.color = 'white';
        successMsg.style.padding = '10px 20px';
        successMsg.style.borderRadius = '4px';
        successMsg.style.zIndex = '1000';
        document.body.appendChild(successMsg);
        
        setTimeout(() => {
          document.body.removeChild(successMsg);
        }, 3000);
      });
      
      editorFooter.appendChild(cancelButton);
      editorFooter.appendChild(saveButton);
      
      // Assembla tutto
      editorWrapper.appendChild(editorHeader);
      editorWrapper.appendChild(imageContainer);
      editorWrapper.appendChild(editorFooter);
      
      overlay.appendChild(editorWrapper);
      document.body.appendChild(overlay);
      
      // Inizializza il cropper con un comportamento diverso per le opzioni autoHeight
      let cropperOptions = {
        viewMode: 1,
        dragMode: 'move',
        autoCropArea: 1,
        restore: false,
        guides: true,
        center: true,
        highlight: false,
        cropBoxMovable: true,
        cropBoxResizable: true,
        toggleDragModeOnDblclick: false,
      };
      
      // Se non √® un'opzione con altezza automatica, imposta il rapporto d'aspetto fisso
      if (!imageData.cropParams.autoHeight) {
        cropperOptions.aspectRatio = imageData.width / imageData.height;
      }
      
      let customCropper = new Cropper(cropperImage, cropperOptions);
    }

    // Aggiungi questo al JavaScript esistente
    const titleButton = document.getElementById('titleButton');
    
    titleButton.addEventListener('click', () => {
      // Resetta l'applicazione e torna alla schermata iniziale
      resetApp();
    });

    // Recupera il riferimento al nuovo pulsante
    const newUploadBtn = document.getElementById('newUploadBtn');
    
    // Aggiungi l'event listener per il pulsante "Carica nuovo"
    newUploadBtn.addEventListener('click', () => {
      // Usa la funzione resetApp esistente per tornare alla schermata iniziale
      resetApp();
    });
  </script>
</body>
</html>